<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkel View - Location Intelligence</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase v9 CDN (Compat version for easier setup) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
    <!-- Authentication Section -->
    <div id="auth-container">
        <h1>Merkel View</h1>
        
        <!-- Step 1: Email Entry -->
        <div id="email-step" class="auth-step">
            <h2>Welcome Back</h2>
            <p>Enter your email to get started</p>
            <form id="email-form">
                <input type="email" id="email-input" placeholder="Email" required autocomplete="email">
                <button type="submit" id="email-continue-btn">Continue</button>
            </form>
            <div class="auth-links">
                <button type="button" id="show-register-btn" class="link-btn">Don't have an account? Register</button>
            </div>
        </div>
        
        <!-- Step 2: Password Entry -->
        <div id="password-step" class="auth-step" style="display: none;">
            <h2>Enter Password</h2>
            <p id="password-email-display"></p>
            <form id="password-form">
                <input type="email" id="password-email-hidden" style="display: none;" autocomplete="username">
                <input type="password" id="password-input" placeholder="Password" required autocomplete="current-password">
                <button type="submit" id="password-login-btn">Sign In</button>
            </form>
            <div class="auth-links">
                <button type="button" id="forgot-password-btn" class="link-btn">Forgot Password?</button>
                <button type="button" id="back-to-email-btn" class="link-btn">Back to email</button>
            </div>
        </div>
        
        <!-- Registration Form -->
        <div id="register-step" class="auth-step" style="display: none;">
            <h2>Create Account</h2>
            <p class="registration-notice">All fields are required. You'll need to verify your email before accessing the app.</p>
            <form id="register-form">
                <div class="form-row">
                    <input type="text" id="first-name" placeholder="First Name" required autocomplete="given-name">
                    <input type="text" id="last-name" placeholder="Last Name" required autocomplete="family-name">
                </div>
                <input type="email" id="register-email" placeholder="Email" required autocomplete="email">
                <input type="tel" id="phone" placeholder="Phone Number" required autocomplete="tel">
                <input type="password" id="register-password" placeholder="Password (min 6 characters)" required minlength="6" autocomplete="new-password">
                <input type="password" id="confirm-password" placeholder="Confirm Password" required minlength="6" autocomplete="new-password">
                <button type="submit" id="register-submit-btn">Create Account</button>
            </form>
            <div class="auth-links">
                <button type="button" id="back-to-login-btn" class="link-btn">Already have an account? Sign In</button>
            </div>
        </div>
        
        <!-- Password Reset -->
        <div id="password-reset-step" class="auth-step" style="display: none;">
            <h2>Reset Password</h2>
            <p>Enter your email address and we'll send you a link to reset your password.</p>
            <form id="password-reset-form">
                <input type="email" id="reset-email" placeholder="Email" required autocomplete="email">
                <button type="submit" id="send-reset-btn">Send Reset Link</button>
            </form>
            <div class="auth-links">
                <button type="button" id="back-to-password-btn" class="link-btn">Back to Sign In</button>
            </div>
        </div>
        
        <!-- Email Verification -->
        <div id="email-verification-step" class="auth-step" style="display: none;">
            <h2>Verify Your Email</h2>
            <p>We've sent a verification email to <span id="verification-email-display"></span></p>
            <p>Please check your inbox and click the verification link before continuing.</p>
            <div class="verification-actions">
                <button type="button" id="resend-verification-btn">Resend Verification Email</button>
                <button type="button" id="refresh-verification-btn">I've Verified - Continue</button>
            </div>
            <div class="auth-links">
                <button type="button" id="logout-from-verification-btn" class="link-btn">Use Different Account</button>
            </div>
        </div>
        
        <div id="auth-status"></div>
    </div>

    <!-- Main App Section (hidden until authenticated) -->
    <div id="app-container" style="display: none;">
        <div class="app-header">
            <h2>Merkel View Dashboard</h2>
            <div class="user-controls">
                <span id="user-email-display"></span>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="app-content">
            <!-- Map Controls -->
            <div class="map-controls">
                <div class="search-container">
                    <input type="text" id="address-search" placeholder="Search for address, city, or landmark..." />
                    <button id="search-btn">Search</button>
                </div>
                <div class="map-instructions">
                    <p id="map-instruction-text">üí° <strong>Click on the map</strong> to add a location, or search for an address above</p>
                    <p id="geocoding-warning" style="display: none; color: #ff9800; font-size: 12px;">
                        ‚ö†Ô∏è Address search disabled. Enable Geocoding API in Google Cloud Console for full functionality.
                    </p>
                </div>
            </div>
            
            <div id="map" style="height: 500px; width: 100%; margin: 20px 0;"></div>
            
            <div id="sidebar">
                <h3>Locations</h3>
                <button id="add-location-btn">Manual Add Location</button>
                <div id="location-list"></div>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" style="display: none;">
        <p>Loading...</p>
    </div>

    <!-- Add Location Modal -->
    <div id="location-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Location</h2>
                <span class="close" id="close-modal">&times;</span>
            </div>
            <form id="location-form" class="location-form">
                <div class="form-group">
                    <label>Location Name *</label>
                    <input type="text" id="location-name" placeholder="Enter a name for this location" required>
                </div>
                <div class="form-group">
                    <label>Address/Location</label>
                    <input type="text" id="location-address" readonly>
                    <small>Selected from map click or search</small>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <input type="text" id="location-coords" readonly>
                    <small>Latitude, Longitude</small>
                </div>
                <div class="form-group">
                    <label>State</label>
                    <select id="location-state" required>
                        <option value="">Select State</option>
                        <option value="AL">Alabama</option>
                        <option value="CA">California</option>
                        <option value="FL">Florida</option>
                        <option value="NY">New York</option>
                        <option value="TX">Texas</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="location-city" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="location-category" required>
                        <option value="">Select Category</option>
                        <option value="restaurant">Restaurant</option>
                        <option value="hotel">Hotel</option>
                        <option value="attraction">Tourist Attraction</option>
                        <option value="business">Business</option>
                        <option value="landmark">Landmark</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="location-notes" rows="3" placeholder="Add any notes about this location..."></textarea>
                </div>
                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="location-photo" accept="image/*">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-location">Cancel</button>
                    <button type="submit" class="btn-primary">Save Location</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Load appropriate config based on environment and then load other scripts
        function loadConfig() {
            return new Promise((resolve, reject) => {
                if (window.location.hostname.includes('github.io')) {
                    // GitHub Pages - try to load production config, fallback to regular config
                    console.log('üåç Loading production config for GitHub Pages...');
                    const script = document.createElement('script');
                    script.src = 'config.production.js?' + Date.now(); // Cache busting
                    script.onload = () => {
                        console.log('‚úÖ Production config loaded successfully');
                        resolve();
                    };
                    script.onerror = () => {
                        console.log('‚ö†Ô∏è Production config not found, using regular config');
                        const fallbackScript = document.createElement('script');
                        fallbackScript.src = 'config.js?' + Date.now();
                        fallbackScript.onload = () => {
                            console.log('‚úÖ Fallback config loaded');
                            resolve();
                        };
                        fallbackScript.onerror = () => {
                            console.error('‚ùå Failed to load any config file');
                            reject(new Error('Failed to load config'));
                        };
                        document.head.appendChild(fallbackScript);
                    };
                    document.head.appendChild(script);
                } else {
                    // Local development - load regular config
                    console.log('üè† Loading development config...');
                    const script = document.createElement('script');
                    script.src = 'config.js?' + Date.now();
                    script.onload = () => {
                        console.log('‚úÖ Development config loaded');
                        resolve();
                    };
                    script.onerror = () => {
                        console.error('‚ùå Failed to load config.js');
                        reject(new Error('Failed to load config.js'));
                    };
                    document.head.appendChild(script);
                }
            });
        }
        
        // Load scripts in order after config is ready
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src + '?' + Date.now(); // Cache busting
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`‚ùå Failed to load: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }
        
        // Initialize the app
        async function initializeApp() {
            try {
                console.log('üöÄ Initializing Merkel View...');
                
                // 1. Load config first
                await loadConfig();
                console.log('üìã Config ready, loading other scripts...');
                
                // 2. Load scripts in order
                await loadScript('firebase-init.js');
                await loadScript('maps-loader.js');
                await loadScript('app.js');
                
                console.log('üéâ All scripts loaded successfully!');
            } catch (error) {
                console.error('üí• Failed to initialize app:', error);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>